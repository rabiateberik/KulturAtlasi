@model KulturAtlasi.Models.AyarlarViewModel

@{
    ViewData["Title"] = "Hesap Ayarları";
}

<style>
    .cursor-pointer {
        cursor: pointer;
    }
    /* Input group focus olduğunda şık görünmesi için */
    .input-group:focus-within .form-control,
    .input-group:focus-within .input-group-text {
        border-color: #86b7fe;
        box-shadow: none;
    }

    .input-group-text {
        transition: all 0.2s;
    }
</style>

<div class="container py-5">
    <div class="row g-4">

        @* --- SOL MENÜ --- *@
        <div class="col-md-3">
            <div class="list-group shadow-sm border-0 rounded-4 overflow-hidden">
                <button class="list-group-item list-group-item-action active border-0 py-3 d-flex align-items-center" onclick="tabDegistir('guvenlik', this)">
                    <i class="bi bi-shield-lock me-3 fs-5"></i>
                    <div>
                        <span class="fw-bold d-block">Şifre ve Güvenlik</span>
                        <small class="opacity-75" style="font-size: 0.7rem;">Şifre yenileme</small>
                    </div>
                </button>
                <button class="list-group-item list-group-item-action border-0 py-3 d-flex align-items-center" onclick="tabDegistir('gizlilik', this)">
                    <i class="bi bi-eye-slash me-3 fs-5"></i>
                    <div>
                        <span class="fw-bold d-block">Gizlilik</span>
                        <small class="text-muted" style="font-size: 0.7rem;">Hesap görünürlüğü</small>
                    </div>
                </button>
            </div>
        </div>

        @* --- SAĞ İÇERİK --- *@
        <div class="col-md-9">

            @if (TempData["Basari"] != null)
            {
                <div class="alert alert-success rounded-4 border-0 shadow-sm mb-4 d-flex align-items-center">
                    <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                    <div>@TempData["Basari"]</div>
                </div>
            }

            @if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger rounded-4 border-0 shadow-sm mb-4">
                    <div asp-validation-summary="All" class="mb-0 small"></div>
                </div>
            }

            @* --- ŞİFRE VE GÜVENLİK TABI --- *@
            <div id="tab-guvenlik" class="tab-icerik">
                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-header bg-white border-0 py-4 px-4">
                        <h5 class="fw-bold mb-0 text-primary">Şifre Değiştir</h5>
                    </div>
                    <div class="card-body p-4">
                        <form asp-action="SifreDegistir" method="post">

                            <div class="mb-4">
                                <label class="small text-muted fw-bold mb-1">Kayıtlı E-Posta</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="bi bi-envelope"></i></span>
                                    <input type="text" class="form-control bg-light border-0" value="@Model.Eposta" disabled>
                                </div>
                            </div>

                            <hr class="my-4 text-muted opacity-25">

                            <div class="mb-3">
                                <label class="small text-muted fw-bold mb-1">Mevcut Şifren</label>
                                <div class="input-group">
                                    <input asp-for="MevcutSifre" id="passMevcut" class="form-control border-end-0 shadow-none" placeholder="Şu anki şifreni gir" required>
                                    <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="toggleSifre('passMevcut', this)">
                                        <i class="bi bi-eye text-muted"></i>
                                    </span>
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="small text-muted fw-bold mb-1">Yeni Şifre</label>
                                    <div class="input-group">
                                        <input asp-for="YeniSifre" id="passYeni" class="form-control border-end-0 shadow-none" placeholder="Yeni şifre belirle" required>
                                        <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="toggleSifre('passYeni', this)">
                                            <i class="bi bi-eye text-muted"></i>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="small text-muted fw-bold mb-1">Yeni Şifre (Tekrar)</label>
                                    <div class="input-group">
                                        <input asp-for="YeniSifreTekrar" id="passTekrar" class="form-control border-end-0 shadow-none" placeholder="Şifreyi doğrula" required>
                                        <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="toggleSifre('passTekrar', this)">
                                            <i class="bi bi-eye text-muted"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 text-end">
                                <button type="submit" class="btn btn-primary rounded-pill px-5 fw-bold shadow-sm">
                                    Güncelle
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            @* --- GİZLİLİK TABI --- *@
            <div id="tab-gizlilik" class="tab-icerik" style="display: none;">
                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-header bg-white border-0 py-4 px-4">
                        <h5 class="fw-bold mb-0 text-primary">Hesap Gizliliği</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center p-3 rounded-3 bg-light border">
                            <div>
                                <h6 class="fw-bold mb-1 text-dark"><i class="bi bi-lock-fill me-2 text-warning"></i>Gizli Hesap</h6>
                                <p class="text-muted small mb-0" style="max-width: 450px;">
                                    Hesabın gizli olduğunda, sadece onayladığın takipçiler paylaşımlarını, kitaplığını ve film listeni görebilir.
                                </p>
                            </div>
                            <div class="form-check form-switch ms-3">
                                <input class="form-check-input shadow-none" type="checkbox" id="gizlilikSwitch" style="width: 3.5rem; height: 1.75rem; cursor: pointer;"
                                       @(Model.GizliHesap ? "checked" : "") onchange="gizlilikDegis(this)">
                            </div>
                        </div>

                        <div id="gizlilikDurumYazisi" class="mt-3 text-center small fw-bold">
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // Şifre Göster/Gizle Fonksiyonu
    function toggleSifre(inputId, element) {
        var input = document.getElementById(inputId);
        var icon = element.querySelector('i');

        if (input.type === "password") {
            input.type = "text";
            icon.classList.replace('bi-eye', 'bi-eye-slash');
        } else {
            input.type = "password";
            icon.classList.replace('bi-eye-slash', 'bi-eye');
        }
    }

    // Sayfa Yüklendiğinde Durum Yazısını Ayarla
    document.addEventListener("DOMContentLoaded", function() {
        var chk = document.getElementById('gizlilikSwitch');
        if(chk) durumYazisiGuncelle(chk.checked);
    });

    // Sekme Değiştirme
    function tabDegistir(tabAdi, element) {
        document.querySelectorAll('.tab-icerik').forEach(el => el.style.display = 'none');
        document.getElementById('tab-' + tabAdi).style.display = 'block';

        document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
    }

    // Gizlilik Ayarı (AJAX)
    function gizlilikDegis(checkbox) {
        var durum = checkbox.checked;
        checkbox.disabled = true;

        fetch('/Kullanicilar/GizlilikGuncelle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'gizliHesap=' + durum
        })
        .then(res => res.json())
        .then(data => {
            checkbox.disabled = false;
            if(data.success) {
                durumYazisiGuncelle(durum);
            } else {
                alert("Hata oluştu. Lütfen tekrar dene.");
                checkbox.checked = !durum;
            }
        });
    }

    function durumYazisiGuncelle(durum) {
        var yaziAlani = document.getElementById('gizlilikDurumYazisi');
        if(!yaziAlani) return;
        if(durum) {
            yaziAlani.innerHTML = '<span class="text-danger"><i class="bi bi-lock"></i> Hesabın GİZLİ modda.</span>';
        } else {
            yaziAlani.innerHTML = '<span class="text-success"><i class="bi bi-globe"></i> Hesabın HERKESE AÇIK.</span>';
        }
    }
</script>