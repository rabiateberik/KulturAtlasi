@model KulturAtlasi.Models.Muzik

@{
    ViewData["Title"] = "Yeni Müzik Ekle";
}

<div class="container py-4">
    <div class="row">

        <div class="col-md-5">
            <div class="card shadow-sm border-0 mb-3 bg-light">
                <div class="card-body">
                    <h5 class="card-title fw-bold mb-3"><i class="bi bi-music-note-beamed"></i> Müzik Ara (Apple)</h5>
                    <div class="input-group">
                        <input type="text" id="txtMuzikAra" class="form-control" placeholder="Şarkı veya Albüm adı...">
                        <button class="btn btn-info text-white fw-bold" type="button" onclick="muzikAra()">Bul</button>
                    </div>
                    <small class="text-muted">Örn: <i>Tarkan, Queen, Sezen Aksu</i></small>
                </div>
            </div>

            <div id="sonucListesi" class="list-group mb-4 shadow-sm" style="display:none; max-height: 400px; overflow-y: auto;">
            </div>

            <div class="card shadow border-0 text-center p-3" id="onizlemeKarti" style="display:none;">
                <span class="badge bg-success position-absolute top-0 end-0 m-2">Seçildi <i class="bi bi-check"></i></span>
                <img id="imgOnizleme" src="" class="img-fluid rounded mx-auto d-block shadow-sm" style="max-height: 400px;" alt="Albüm Kapağı">

                <div class="mt-3">
                    <div class="input-group input-group-sm">
                        <input type="text" id="txtManuelResim" class="form-control" placeholder="Resim linki yapıştır..." onchange="manuelResimGuncelle()">
                        <button class="btn btn-outline-secondary" type="button" onclick="manuelResimGuncelle()">Güncelle</button>
                    </div>
                </div>

                <h5 id="lblBaslik" class="fw-bold mt-3 text-dark"></h5>
                <p id="lblSanatci" class="text-muted"></p>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card shadow border-0">
                <div class="card-header bg-info text-white py-3">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-headphones"></i> Müzik Bilgileri</h5>
                </div>
                <div class="card-body">
                    <form asp-action="Create">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        <input type="hidden" asp-for="KapakResmiYolu" id="inputKapak" />
                        <input type="hidden" asp-for="DinlemeLinki" id="inputSes" /> <div class="mb-3">
                            <label asp-for="Baslik" class="form-label fw-bold">Şarkı / Albüm Adı</label>
                            <input asp-for="Baslik" class="form-control" id="inputBaslik" />
                            <span asp-validation-for="Baslik" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Sanatci" class="form-label fw-bold">Sanatçı</label>
                                <input asp-for="Sanatci" class="form-control" id="inputSanatci" />
                                <span asp-validation-for="Sanatci" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Album" class="form-label">Albüm</label>
                                <input asp-for="Album" class="form-control" id="inputAlbum" />
                                <span asp-validation-for="Album" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="Tur" class="form-label">Tür</label>
                                <input asp-for="Tur" class="form-control" id="inputTur" />
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="Yil" class="form-label">Çıkış Yılı</label>
                                <input asp-for="Yil" class="form-control" id="inputYil" />
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="KullaniciPuani" class="form-label">Puan (1-5)</label>
                                <input asp-for="KullaniciPuani" type="number" min="1" max="5" class="form-control" value="0" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold bg-warning bg-opacity-10 px-2 rounded">Durumu</label>
                            <select asp-for="DurumID" class="form-select" asp-items="ViewBag.DurumID"></select>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Aciklama" class="form-label">Notlar</label>
                            <textarea asp-for="Aciklama" class="form-control" rows="3"></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check-lg"></i> Arşive Ekle
                            </button>
                            <a asp-action="Index" class="btn btn-outline-secondary">İptal</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        var bulunanMuzikler = [];

        async function muzikAra() {
            var sorgu = document.getElementById("txtMuzikAra").value;
            if (!sorgu) { alert("Lütfen bir şeyler yazın!"); return; }

            var btn = event.target;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            btn.disabled = true;

            // Apple Music API (Türkiye Mağazası)
            var url = `https://itunes.apple.com/search?term=${encodeURIComponent(sorgu)}&country=TR&media=music&limit=6`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.resultCount > 0) {
                        bulunanMuzikler = data.results;
                        listeyiDoldur(bulunanMuzikler);
                    } else {
                        alert("Müzik bulunamadı!");
                        document.getElementById("sonucListesi").style.display = "none";
                    }
                })
                .catch(err => { console.error(err); alert("Hata oluştu."); })
                .finally(() => {
                    btn.innerHTML = "Bul";
                    btn.disabled = false;
                });
        }

        function listeyiDoldur(muzikler) {
            var liste = document.getElementById("sonucListesi");
            liste.innerHTML = "";
            liste.style.display = "block";

            muzikler.forEach((m, index) => {
                var img = m.artworkUrl100;
                var yil = m.releaseDate ? m.releaseDate.substring(0, 4) : "";
                var tur = m.primaryGenreName || "";

                var html = `
                    <button type="button" class="list-group-item list-group-item-action d-flex gap-3 py-2" onclick="muzikSec(${index})">
                        <img src="${img}" width="50" height="50" class="rounded shadow-sm">
                        <div class="d-flex gap-2 w-100 justify-content-between">
                            <div style="overflow:hidden;">
                                <h6 class="mb-0 fw-bold text-truncate">${m.trackName}</h6>
                                <p class="mb-0 opacity-75 small text-truncate">${m.artistName}</p>
                            </div>
                            <div class="text-end">
                                <small class="opacity-50 text-nowrap fw-bold d-block">${yil}</small>
                                <span class="badge bg-light text-dark border" style="font-size:0.6rem;">${tur}</span>
                            </div>
                        </div>
                    </button>
                `;
                liste.innerHTML += html;
            });
        }

        function muzikSec(index) {
            var m = bulunanMuzikler[index];

            // Formu Doldur
            document.getElementById("inputBaslik").value = m.trackName;
            document.getElementById("inputSanatci").value = m.artistName;
            document.getElementById("inputAlbum").value = m.collectionName;
            document.getElementById("inputTur").value = m.primaryGenreName;
            document.getElementById("inputYil").value = m.releaseDate ? m.releaseDate.substring(0, 4) : "";

            // --- YENİ: SES LİNKİNİ AL ---
            if (m.previewUrl) {
                document.getElementById("inputSes").value = m.previewUrl;
            } else {
                document.getElementById("inputSes").value = "";
            }

            // --- HD KAPAK HİLESİ ---
            var hdKapak = "";
            if(m.artworkUrl100) {
                hdKapak = m.artworkUrl100.replace("100x100bb", "1000x1000bb");
            }

            resmiGuncelle(hdKapak);

            document.getElementById("lblBaslik").innerText = m.trackName;
            document.getElementById("lblSanatci").innerText = m.artistName;
            document.getElementById("sonucListesi").style.display = "none";
        }

        function manuelResimGuncelle() {
            var url = document.getElementById("txtManuelResim").value;
            if(url) resmiGuncelle(url);
        }

        function resmiGuncelle(url) {
            var img = document.getElementById("imgOnizleme");
            var hiddenInput = document.getElementById("inputKapak");
            var placeholder = "https://via.placeholder.com/300x300?text=Resim+Yok";

            var finalUrl = url ? url : placeholder;

            document.getElementById("onizlemeKarti").style.display = "block";
            img.src = finalUrl;
            hiddenInput.value = finalUrl;

            if(document.getElementById("txtManuelResim").value !== url) {
                 document.getElementById("txtManuelResim").value = url;
            }

            img.onerror = function() {
                this.src = placeholder;
            }
        }
    </script>
}