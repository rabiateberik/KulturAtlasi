@using Microsoft.AspNetCore.Identity
@using KulturAtlasi.Models
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

<ul class="navbar-nav align-items-center">
    @if (SignInManager.IsSignedIn(User))
    {
        var user = await UserManager.GetUserAsync(User);
        var userId = await UserManager.GetUserIdAsync(user);

        if (user != null)
        {
            <li class="nav-item dropdown me-3">
                <a class="nav-link text-dark fs-5 position-relative p-0" href="#" id="bildirimDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" onclick="bildirimleriYukle()">
                    <i class="bi bi-bell-fill" style="font-size: 1.4rem;"></i>

                    <span id="bildirimNoktasi" class="position-absolute bg-danger border border-2 border-white rounded-circle"
                          style="display: none; width: 12px; height: 12px; top: 2px; right: -2px;">
                    </span>
                </a>

                <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 p-0" aria-labelledby="bildirimDropdown" style="width: 320px; max-height: 400px; overflow-y: auto; border-radius: 12px;">
                    <li class="p-3 border-bottom bg-light">
                        <h6 class="mb-0 fw-bold text-primary">Bildirimler</h6>
                    </li>

                    <div id="bildirimListesiContainer">
                    <li class="text-center p-4 text-muted small">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div> Yükleniyor...
                    </li>
                    </div>

                    <li class="border-top">
                        <a class="dropdown-item text-center small py-2 text-muted fw-bold" href="/Bildirimler">
                            Tümünü Gör
                        </a>
                    </li>
                </ul>
            </li>
            <li class="nav-item dropdown">

                <a class="nav-link dropdown-toggle d-flex align-items-center gap-2 p-1 pe-3 rounded-pill hover-bg-light text-dark fw-bold"
                   href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">

                    @if (!string.IsNullOrEmpty(user.ProfilFotografiYolu))
                    {
                        <img src="@user.ProfilFotografiYolu" class="rounded-circle border shadow-sm"
                             style="width: 38px; height: 38px; object-fit: cover;">
                    }
                    else
                    {
                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center fw-bold shadow-sm"
                             style="width: 38px; height: 38px; font-size: 1rem;">
                            @(user.Ad?.Substring(0, 1).ToUpper() ?? "?")
                        </div>
                    }

                    <span class="small">@user.Ad @user.Soyad</span>
                </a>

                <ul class="dropdown-menu dropdown-menu-end shadow border-0 mt-2" aria-labelledby="navbarDropdown" style="border-radius: 12px;">

                    <li><h6 class="dropdown-header">Merhaba, @user.KullaniciAdi!</h6></li>

                    <li>
                        <a class="dropdown-item py-2" asp-controller="Kullanicilar" asp-action="Profil" asp-route-id="@userId">
                            <i class="bi bi-person-badge me-2 text-primary"></i> Profilim
                        </a>
                    </li>

                    <li>
                        <a class="dropdown-item py-2" asp-controller="Home" asp-action="Index">
                            <i class="bi bi-bar-chart-line me-2 text-warning"></i> Kişisel Arşivim
                        </a>
                    </li>

                    <li>
                        <a class="nav-link text-dark" asp-controller="Kullanicilar" asp-action="Ayarlar">
                            <i class="bi bi-gear-fill me-1"></i> Ayarlar
                        </a>
                    </li>

                    <li><hr class="dropdown-divider"></li>

                    <li>
                        <form class="form-inline" asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })">
                            <button type="submit" class="dropdown-item py-2 text-danger fw-bold">
                                <i class="bi bi-box-arrow-right me-2"></i> Çıkış Yap
                            </button>
                        </form>
                    </li>
                </ul>
            </li>
        }
    }
    else
    {
        <li class="nav-item">
            <a class="btn btn-outline-primary btn-sm me-2 rounded-pill px-3" asp-area="Identity" asp-page="/Account/Register">Kayıt Ol</a>
        </li>
        <li class="nav-item">
            <a class="btn btn-primary btn-sm rounded-pill px-3" asp-area="Identity" asp-page="/Account/Login">Giriş Yap</a>
        </li>
    }
</ul>
<script>
    // Sayfa yüklendiğinde bildirim kontrolü yap
    document.addEventListener("DOMContentLoaded", function() {
        fetch('/Home/GetOkunmamisBildirimSayisi')
            .then(response => response.json())
            .then(sayi => {
                if (sayi > 0) {
                    document.getElementById('bildirimNoktasi').style.display = 'inline-block';
                }
            });
    });
</script>
<style>
    .hover-bg-light:hover {
        background-color: #f8f9fa;
    }

    .dropdown-item:active {
        background-color: #e9ecef;
        color: black;
    }
   
</style>
