<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - KültürAtlası</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/KulturAtlasi.styles.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* 1. TÜM SAYFAYI FLEX YAP (Footer'ı aşağı itmek için şart) */
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Ekran boyuna zorla */
            margin: 0;
            background-color: #f8f9fa;
        }

        /* 2. SİDEBAR SABİTLEME DÜZENİ */
        #sidebarMenu {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-color: #212529;
        }

            /* Kaydırma çubuğunu gizle */
            #sidebarMenu::-webkit-scrollbar {
                display: none;
            }

        #sidebarMenu {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

       /
        main {
            margin-left: 0;
            display: flex;
            flex-direction: column;
            flex: 1; /
            min-height: 100vh;
        }

        @@media (min-width: 768px) {
            main

        {
            margin-left: 16.666667%; 
        }

        }

        
        .content-wrapper {
            flex: 1; 
        }

        
        .sidebar-nav-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding-bottom: 20px;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 10px;
        }

     
        footer {
            width: 100%;
            background-color: white;
        }

        .global-search-results .card {
            transition: transform 0.2s;
        }

            .global-search-results .card:hover {
                transform: scale(1.02);
                box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
            }

        .toast-container {
            z-index: 9999 !important;
        }

        #paylasimToast {
            min-width: 300px;
        }

        .toast {
            transition: opacity 0.5s ease-in-out;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .input-group:focus-within {
            ring: 2px;
            outline: 2px solid #0d6efd; 
        }
    </style>
</head>
<body class="bg-light">

    <div class="container-fluid">
        <div class="row">

            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse shadow">
                <div class="sidebar-nav-container pt-3 text-white w-100">

                    <a href="/" class="d-flex align-items-center mb-4 me-md-auto text-white text-decoration-none border-bottom pb-3 px-3">
                        <span class="fs-4 fw-bold">📚 KültürAtlası</span>
                    </a>

                    <ul class="nav flex-column px-2">
                        <li class="nav-item">
                            <a href="/" class="nav-link text-white"><i class="bi bi-house-door me-2"></i> Ana Sayfa</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" asp-controller="Kesfet" asp-action="Index"><i class="bi bi-globe-americas me-2"></i> Keşfet</a>
                        </li>

                        <li class="nav-item my-2">
                            <a href="#menuPaylasim" class="nav-link text-warning d-flex justify-content-between align-items-center fw-bold" data-bs-toggle="collapse">
                                <span><i class="bi bi-pencil-square me-2"></i> Gönderi Oluştur</span>
                                <i class="bi bi-chevron-down small"></i>
                            </a>
                            <div class="collapse" id="menuPaylasim">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small bg-secondary bg-opacity-25 ms-3 rounded">
                                    <li><a href="#" class="nav-link text-white" onclick="globalModalAc('Düşünce'); return false;">💭 Düşünce Paylaş</a></li>
                                    <li><a href="#" class="nav-link text-white" onclick="globalModalAc('Alıntı'); return false;">📖 Alıntı Ekle</a></li>
                                    <li><a href="#" class="nav-link text-white" onclick="globalModalAc('İnceleme'); return false;">📝 İnceleme Yaz</a></li>
                                    <li><a href="#" class="nav-link text-white" onclick="globalModalAc('Replik'); return false;">🎬 Replik Ekle</a></li>
                                </ul>
                            </div>
                        </li>

                        <li class="nav-item">
                            <a href="#menuKitaplar" class="nav-link text-white d-flex justify-content-between align-items-center" data-bs-toggle="collapse">
                                <span><i class="bi bi-book me-2"></i> Kitaplarım</span>
                                <i class="bi bi-chevron-down small"></i>
                            </a>
                            <div class="collapse" id="menuKitaplar">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small bg-secondary bg-opacity-25 ms-3 rounded">
                                    <li><a href="/Kitaplar" class="nav-link text-white-50">📋 Tümü</a></li>
                                    <li><a href="/Kitaplar?durum=Okudum" class="nav-link text-white-50">✅ Okuduklarım</a></li>
                                    <li><a href="/Kitaplar?durum=Okuyacağım" class="nav-link text-white-50">⏳ Okuyacaklarım</a></li>
                                    <li><a href="/Kitaplar?durum=Yarida" class="nav-link text-white-50">🌗 Yarıda Bıraktıklarım</a></li>
                                </ul>
                            </div>
                        </li>

                        <li class="nav-item">
                            <a href="#menuFilmler" class="nav-link text-white d-flex justify-content-between align-items-center" data-bs-toggle="collapse">
                                <span><i class="bi bi-film me-2"></i> Filmlerim</span>
                                <i class="bi bi-chevron-down small"></i>
                            </a>
                            <div class="collapse" id="menuFilmler">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small bg-secondary bg-opacity-25 ms-3 rounded">
                                    <li><a href="/Filmler" class="nav-link text-white-50">📋 Tümü</a></li>
                                    <li><a href="/Filmler?durum=Izledim" class="nav-link text-white-50">✅ İzlediklerim</a></li>
                                    <li><a href="/Filmler?durum=Izleyecegim" class="nav-link text-white-50">⏳ İzleyeceklerim</a></li>
                                </ul>
                            </div>
                        </li>

                        <li class="nav-item">
                            <a href="#menuDiziler" class="nav-link text-white d-flex justify-content-between align-items-center" data-bs-toggle="collapse">
                                <span><i class="bi bi-tv me-2"></i> Dizilerim</span>
                                <i class="bi bi-chevron-down small"></i>
                            </a>
                            <div class="collapse" id="menuDiziler">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small bg-secondary bg-opacity-25 ms-3 rounded">
                                    <li><a href="/Diziler" class="nav-link text-white-50">📋 Tümü</a></li>
                                    <li><a href="/Diziler?durum=Izledim" class="nav-link text-white-50">✅ İzlediklerim</a></li>
                                    <li><a href="/Diziler?durum=Izliyorum" class="nav-link text-white-50">▶️ İzliyorum</a></li>
                                    <li><a href="/Diziler?durum=Izleyecegim" class="nav-link text-white-50">⏳ İzleyeceğim</a></li>
                                </ul>
                            </div>
                        </li>

                        <li class="nav-item">
                            <a href="#menuMuzikler" class="nav-link text-white d-flex justify-content-between align-items-center" data-bs-toggle="collapse">
                                <span><i class="bi bi-music-note-beamed me-2"></i> Müziklerim</span>
                                <i class="bi bi-chevron-down small"></i>
                            </a>
                            <div class="collapse" id="menuMuzikler">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small bg-secondary bg-opacity-25 ms-3 rounded">
                                    <li><a href="/Muzikler" class="nav-link text-white-50">📋 Tümü</a></li>
                                    <li><a href="/Muzikler?durum=Dinledim" class="nav-link text-white-50">🎧 Dinlediklerim</a></li>
                                    <li><a href="/Muzikler?durum=Favorilerim" class="nav-link text-white-50">❤️ Favorilerim</a></li>
                                </ul>
                            </div>
                        </li>

                        <li class="nav-item">
                            <a href="#menuSeyahatler" class="nav-link text-white d-flex justify-content-between align-items-center" data-bs-toggle="collapse">
                                <span><i class="bi bi-geo-alt me-2"></i> Seyahatlerim</span>
                                <i class="bi bi-chevron-down small"></i>
                            </a>
                            <div class="collapse" id="menuSeyahatler">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small bg-secondary bg-opacity-25 ms-3 rounded">
                                    <li><a href="/Seyahatler" class="nav-link text-white-50">📋 Tümü</a></li>
                                    <li><a href="/Seyahatler?durum=Gittim" class="nav-link text-white-50">✅ Gittiklerim</a></li>
                                    <li><a href="/Seyahatler?durum=GitmekIstiyorum" class="nav-link text-white-50">⏳ Gezeceklerim</a></li>
                                </ul>
                            </div>
                        </li>

                        <li class="nav-item mt-3 border-top pt-3">
                            <a href="/Kullanicilar" class="nav-link text-white"><i class="bi bi-people-fill me-2"></i> Topluluk</a>
                        </li>
                    </ul>

                    <div class="sidebar-footer">
                        <li class="nav-item border-top pt-2" style="list-style:none;">
                            <a asp-controller="Home" asp-action="Iletisim" class="nav-link text-info">
                                <i class="bi bi-headset me-2"></i> Bize Ulaşın
                            </a>
                        </li>
                        <li class="nav-item mt-2" style="list-style:none;">
                            <form class="form-inline" asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })">
                                <button type="submit" class="nav-link text-danger bg-transparent border-0 w-100 text-start px-3 fw-bold">
                                    <i class="bi bi-box-arrow-right me-2"></i> Çıkış Yap
                                </button>
                            </form>
                        </li>
                    </div>

                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-0">
                <nav class="navbar navbar-expand navbar-light bg-white shadow-sm px-4 py-2 mb-4 sticky-top">
                    <span class="navbar-brand fw-bold text-primary d-none d-lg-block">@ViewData["Title"]</span>
                    <form class="d-flex mx-auto" action="/Home/Ara" method="get" style="width: 100%; max-width: 450px;">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0 rounded-start-pill ps-3"><i class="bi bi-search text-muted"></i></span>
                            <input class="form-control border-start-0 bg-light rounded-end-pill me-2" type="search" name="q" placeholder="Ara...">
                        </div>
                    </form>
                    <div class="ms-auto d-flex align-items-center">
                        <partial name="_LoginPartial" />
                    </div>
                </nav>

                <div class="px-4 pb-5 content-area">
                    @RenderBody()
                </div>

                <footer class="text-center text-muted py-3 border-top bg-white">
                    <small>&copy; 2025 - KültürAtlası</small>
                </footer>
            </main>

        </div>
    </div>
    <div class="modal fade" id="globalPaylasimModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-primary" id="modalBaslik">Yeni Gönderi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body pt-3">
                    <form asp-controller="Home" asp-action="PaylasimYap" method="post">
                        <input type="hidden" name="PaylasimTuru" id="modalPaylasimTuru" value="Düşünce">

                        <div class="form-floating mb-3">
                            <textarea name="Icerik" class="form-control border-0 bg-light" style="height: 120px" placeholder="Yaz..." required></textarea>
                            <label>Neler söylemek istersin?</label>
                        </div>

                        <div id="modalIcerikSecimi" style="display:none;" class="mb-3 p-3 border rounded bg-light">
                            <small class="text-muted fw-bold d-block mb-2"><i class="bi bi-link-45deg"></i> İlgili Eseri Seç:</small>
                            <div class="row g-2">
                                <div class="col-4">
                                    <select name="IlgiliIcerikTuru" class="form-select form-select-sm" onchange="modalListeGuncelle(this.value)">
                                        <option value="">Tür</option>
                                        <option value="Kitap">Kitap</option>
                                        <option value="Film">Film</option>
                                        <option value="Dizi">Dizi</option>
                                    </select>
                                </div>
                                <div class="col-8">
                                    <select id="modalSelectKitap" class="form-select form-select-sm modal-liste" style="display:none;" disabled></select>
                                    <select id="modalSelectFilm" class="form-select form-select-sm modal-liste" style="display:none;" disabled></select>
                                    <select id="modalSelectDizi" class="form-select form-select-sm modal-liste" style="display:none;" disabled></select>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end border-top pt-3">
                            <button type="button" class="btn btn-light rounded-pill me-2" data-bs-dismiss="modal">İptal</button>
                            <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold">Paylaş</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="paylasimToast" class="toast align-items-center text-white bg-success border-0 rounded-4 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Kapat"></button>
            </div>
        </div>
    </div>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)
    <script>
        
        // Bilidirm sistemi
        document.addEventListener("DOMContentLoaded", function() {
            fetch('/Home/GetOkunmamisBildirimSayisi')
                .then(res => res.json())
                .then(sayi => {
                    var nokta = document.getElementById('bildirimNoktasi');
                    if (sayi > 0 && nokta) {
                        nokta.style.display = 'inline-block';
                        nokta.innerText = sayi > 9 ? "9+" : sayi;
                    }
                });
        });

        // Bildirim Dropdown Menüsünü Doldur
        function bildirimleriYukle() {
            var container = document.getElementById("bildirimListesiContainer");
            var nokta = document.getElementById('bildirimNoktasi');

            if(nokta) nokta.style.display = 'none'; // Tıklanınca sayıyı gizle
            if(container) container.innerHTML = '<li class="text-center p-3 small text-muted"><div class="spinner-border spinner-border-sm"></div> Yükleniyor...</li>';

            fetch('/Home/GetBildirimler')
                .then(res => res.json())
                .then(data => {
                    if(!container) return;
                    container.innerHTML = "";

                    if (data.length === 0) {
                        container.innerHTML = '<li class="text-center p-4 text-muted small">Henüz bildirim yok.</li>';
                        return;
                    }

                    data.forEach(item => {
                        var ikon = 'bi-info-circle text-primary';
                        var bg = item.okundu ? 'bg-white' : 'bg-light';
                        if(item.tur === 'Beğeni') ikon = 'bi-heart-fill text-danger';
                        if(item.tur === 'Takip') ikon = 'bi-person-plus-fill text-success';
                        if(item.tur === 'Yorum') ikon = 'bi-chat-dots-fill text-warning';

                        var html = `
                            <li>
                                <a class="dropdown-item d-flex align-items-start gap-3 p-3 border-bottom ${bg}" href="${item.link}" style="white-space: normal;">
                                    <i class="bi ${ikon} fs-4 mt-1"></i>
                                    <div>
                                        <p class="mb-0 small fw-bold text-dark">${item.mesaj}</p>
                                        <small class="text-muted" style="font-size: 0.7rem;">${item.tarih}</small>
                                    </div>
                                </a>
                            </li>`;
                        container.innerHTML += html;
                    });
                })
                .catch(err => {
                    console.error("Bildirim hatası:", err);
                    if(container) container.innerHTML = '<li class="text-center p-3 text-danger small">Hata oluştu.</li>';
                });
        }

       
        // paylaşım modalalı
        function globalModalAc(tur) {
            if(document.getElementById('modalPaylasimTuru')) document.getElementById('modalPaylasimTuru').value = tur;
            if(document.getElementById('modalBaslik')) document.getElementById('modalBaslik').innerText = tur + " Paylaş";

            var secimAlani = document.getElementById('modalIcerikSecimi');
            if (secimAlani) {
                if (tur === 'Düşünce') {
                    secimAlani.style.display = 'none';
                } else {
                    secimAlani.style.display = 'block';
                    globalVerileriYukle();
                }
            }

            var modalEl = document.getElementById('globalPaylasimModal');
            if (modalEl) {
                var myModal = new bootstrap.Modal(modalEl);
                myModal.show();
            }
        }

        // Kütüphane Verilerini (Kitap/Film/Dizi) AJAX ile Getir
        var globalVerilerYuklendi = false;
        function globalVerileriYukle() {
            if (globalVerilerYuklendi) return;
            fetch('/Home/GetKullaniciKutuphanesi')
                .then(res => res.json())
                .then(data => {
                    globalSelectDoldur('modalSelectKitap', data.kitaplar);
                    globalSelectDoldur('modalSelectFilm', data.filmler);
                    globalSelectDoldur('modalSelectDizi', data.diziler);
                    globalVerilerYuklendi = true;
                    modalListeGuncelle(''); // Temizlik
                });
        }

        function globalSelectDoldur(id, liste) {
            var select = document.getElementById(id);
            if(!select) return;
            select.innerHTML = "<option value=''>Eser Seçiniz...</option>";
            liste.forEach(item => {
                var opt = document.createElement('option');
                opt.value = item.id;
                opt.innerText = item.ad;
                select.appendChild(opt);
            });
        }

        // Tür Seçimine Göre Select Kutusunu Göster/Gizle
        function modalListeGuncelle(tur) {
            document.querySelectorAll('.modal-liste').forEach(el => {
                el.style.display = 'none';
                el.disabled = true;
                el.name = "";
            });

            var hedef = null;
            if (tur === "Kitap") hedef = document.getElementById("modalSelectKitap");
            if (tur === "Film") hedef = document.getElementById("modalSelectFilm");
            if (tur === "Dizi") hedef = document.getElementById("modalSelectDizi");

            if (hedef) {
                hedef.style.display = "block";
                hedef.disabled = false;
                hedef.name = "IlgiliIcerikID";
            }
        }

       
        
        @if (TempData["Basarili"] != null || TempData["Mesaj"] != null)
        {
                <text>
                window.addEventListener('load', function() {
                    setTimeout(function() {
                        var toastEl = document.getElementById('paylasimToast');
                        if (toastEl) {
                            var mesaj = "@Html.Raw(TempData["Basarili"] ?? TempData["Mesaj"])";
                            var toastBody = toastEl.querySelector('.toast-body');

                            if (toastBody) {
                                toastBody.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i> ' + mesaj;
                            }

                            var toast = new bootstrap.Toast(toastEl, {
                                autohide: true,
                                delay: 2000 // 2000 ms = 2 saniye sonra otomatik kapanır
                            });
                            toast.show();
                        }
                    }, 500);
                });
                </text>
        }
    </script>
</body>
</html>

