@model KulturAtlasi.Models.Kitap

@{
    ViewData["Title"] = "Yeni Kitap Ekle";
}

<div class="container py-4">
    <div class="row">

        <div class="col-md-5">

            <div class="card shadow-sm border-0 mb-3 bg-light">
                <div class="card-body">
                    <h5 class="card-title fw-bold mb-3"><i class="bi bi-search"></i> Kitap Bul (Google)</h5>
                    <div class="input-group mb-2">
                        <input type="text" id="txtKitapAra" class="form-control" placeholder="Kitap adı...">
                        <button class="btn btn-primary" type="button" onclick="kitaplariListele()">Ara</button>
                    </div>
                    <small class="text-muted">Örn: <i>Serenad Zülfü Livaneli</i></small>
                </div>
            </div>

            <div id="sonucListesi" class="list-group mb-4 shadow-sm" style="display:none; max-height: 400px; overflow-y: auto;">
            </div>

            <div class="card shadow border-0 text-center p-3" id="onizlemeKarti" style="display:none;">
                <span class="badge bg-success position-absolute top-0 end-0 m-2">Seçildi <i class="bi bi-check"></i></span>

                <div class="mx-auto" style="width: 150px; height: 225px; overflow: hidden; border-radius: 5px;">
                    <img id="imgOnizleme" src="" class="w-100 h-100" style="object-fit: cover;" alt="Kapak">
                </div>

                <div class="mt-3 p-2 bg-light rounded border">
                    <label class="form-label small fw-bold text-muted mb-1">Resim kötü mü?</label>
                    <button type="button" class="btn btn-outline-danger btn-sm w-100 mb-2" onclick="googleGorselAra()">
                        <i class="bi bi-google"></i> Google'da Kapak Ara
                    </button>
                    <div class="input-group input-group-sm">
                        <input type="text" id="txtManuelResim" class="form-control" placeholder="Link yapıştır..." onchange="manuelResimGuncelle()">
                        <button class="btn btn-secondary" type="button" onclick="manuelResimGuncelle()"><i class="bi bi-arrow-clockwise"></i></button>
                    </div>
                </div>

                <h5 id="lblBaslik" class="fw-bold mt-3 text-primary"></h5>
                <p id="lblYazar" class="text-muted"></p>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card shadow border-0">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0 fw-bold text-primary">Kitap Bilgileri</h5>
                </div>
                <div class="card-body">
                    <form asp-action="Create" enctype="multipart/form-data">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        <input type="hidden" asp-for="KapakResmiYolu" id="inputKapakResmi" />

                        <div class="mb-3">
                            <label asp-for="Baslik" class="form-label fw-bold">Kitap Başlığı</label>
                            <input asp-for="Baslik" class="form-control" id="inputBaslik" />
                            <span asp-validation-for="Baslik" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Tur" class="form-label fw-bold text-primary">Türü / Kategorisi (Otomatik)</label>
                            <input asp-for="Tur" class="form-control bg-light text-primary fw-bold" id="inputTur" readonly />
                            <span asp-validation-for="Tur" class="text-danger"></span>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Yazar" class="form-label fw-bold">Yazar</label>
                                <input asp-for="Yazar" class="form-control" id="inputYazar" />
                                <span asp-validation-for="Yazar" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="ISBN" class="form-label">ISBN</label>
                                <input asp-for="ISBN" class="form-control" id="inputISBN" />
                                <span asp-validation-for="ISBN" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3 border rounded p-3 bg-light">
                            <label class="form-label fw-bold">Bilgisayardan Yükle (İsteğe Bağlı)</label>
                            <input type="file" name="resimDosyasi" class="form-control mb-2" accept="image/*" onchange="dosyaOnizle(this)">
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Durumu</label>
                                <select asp-for="DurumID" class="form-select" asp-items="ViewBag.DurumID"></select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Puan (1-5)</label>
                                <input asp-for="KullaniciPuani" type="number" min="1" max="5" class="form-control" value="0" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Aciklama" class="form-label">Açıklama</label>
                            <textarea asp-for="Aciklama" class="form-control" id="inputAciklama" rows="4"></textarea>
                            <span asp-validation-for="Aciklama" class="text-danger"></span>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">Kaydet</button>
                            <a asp-action="Index" class="btn btn-outline-secondary">İptal</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        var bulunanKitaplar = [];

        function kitaplariListele() {
            var kelime = document.getElementById("txtKitapAra").value;
            if (!kelime) { alert("Lütfen bir şey yazın!"); return; }

            var btn = event.target;
            btn.innerHTML = '...';
            btn.disabled = true;

            fetch(`https://www.googleapis.com/books/v1/volumes?q=${kelime}&maxResults=10&langRestrict=tr`)
                .then(response => response.json())
                .then(data => {
                    if (data.totalItems > 0) {
                        bulunanKitaplar = data.items;
                        listeyiDoldur(bulunanKitaplar);
                    } else {
                        alert("Kitap bulunamadı!");
                        document.getElementById("sonucListesi").style.display = "none";
                    }
                })
                .finally(() => { btn.innerHTML = "Ara"; btn.disabled = false; });
        }

        function listeyiDoldur(kitaplar) {
            var listeDiv = document.getElementById("sonucListesi");
            listeDiv.innerHTML = '<h6 class="text-muted small fw-bold w-100 mb-2 px-2">Sonuçlar (Seçiniz):</h6>';
            listeDiv.style.display = "block";

            kitaplar.forEach((item, index) => {
                var info = item.volumeInfo;
                var kapak = "https://via.placeholder.com/50x75?text=Yok";
                if(info.imageLinks && info.imageLinks.thumbnail) {
                    kapak = info.imageLinks.thumbnail.replace(/^http:\/\//i, 'https://').replace("&edge=curl", "");
                }

                var baslik = info.title || "Başlıksız";
                var yazar = info.authors ? info.authors[0] : "Bilinmiyor";
                var yayinci = info.publisher ? info.publisher : "";

                var html = `
                    <button type="button" class="list-group-item list-group-item-action d-flex gap-3 py-2 align-items-center" onclick="kitapSec(${index})">
                        <img src="${kapak}" width="45" height="65" class="rounded border flex-shrink-0" style="object-fit:cover;">
                        <div class="w-100">
                            <h6 class="mb-0 fw-bold small text-primary">${baslik}</h6>
                            <p class="mb-0 opacity-75 small">${yazar}</p>
                            <span class="badge bg-light text-secondary border mt-1" style="font-size:0.6rem;">${yayinci}</span>
                        </div>
                    </button>
                `;
                listeDiv.innerHTML += html;
            });
        }

        function kitapSec(index) {
            var kitap = bulunanKitaplar[index].volumeInfo;

            document.getElementById("inputBaslik").value = kitap.title || "";
            document.getElementById("inputYazar").value = kitap.authors ? kitap.authors[0] : "";

            var isbn = "";
            if (kitap.industryIdentifiers) {
                var isbnObj = kitap.industryIdentifiers.find(x => x.type === "ISBN_13") || kitap.industryIdentifiers[0];
                isbn = isbnObj.identifier;
            }
            document.getElementById("inputISBN").value = isbn;

            // ✨ YENİ: TÜR BİLGİSİNİ ÇEK VE DOLDUR ✨
            var tur = "";
            if (kitap.categories && kitap.categories.length > 0) {
                tur = kitap.categories.join(", ");
            }
            document.getElementById("inputTur").value = tur;
            // ✨ BİTTİ ✨

            var aciklama = kitap.description || "";
            if(aciklama.length > 800) aciklama = aciklama.substring(0, 797) + "...";
            document.getElementById("inputAciklama").value = aciklama;

            // Resmi Ayarla
            var resimUrl = "https://via.placeholder.com/300x450?text=Resim+Yok";
            if (kitap.imageLinks) {
                var rawUrl = kitap.imageLinks.thumbnail || kitap.imageLinks.smallThumbnail;
                if(rawUrl) resimUrl = rawUrl.replace(/^http:\/\//i, 'https://').replace("&edge=curl", "");
            }

            resmiGoster(resimUrl);

            document.getElementById("lblBaslik").innerText = kitap.title;
            document.getElementById("lblYazar").innerText = kitap.authors ? kitap.authors[0] : "";

            document.getElementById("sonucListesi").style.display = "none";
            document.getElementById("onizlemeKarti").style.display = "block";
        }

        // --- YARDIMCI FONKSİYONLAR ---

        function resmiGoster(url) {
            var img = document.getElementById("imgOnizleme");
            var hiddenInput = document.getElementById("inputKapakResmi");
            img.src = url;
            hiddenInput.value = url;
        }

        function googleGorselAra() {
            var baslik = document.getElementById("inputBaslik").value;
            var yazar = document.getElementById("inputYazar").value;
            if(!baslik) baslik = document.getElementById("txtKitapAra").value;
            var query = baslik + " " + yazar + " kitap kapağı";
            var url = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(query)}`;
            window.open(url, '_blank');
        }

        function manuelResimGuncelle() {
            var url = document.getElementById("txtManuelResim").value;
            if(url) resmiGoster(url);
        }

        function dosyaOnizle(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    resmiGoster(e.target.result);
                    document.getElementById("inputKapakResmi").value = "";
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
    </script>
}