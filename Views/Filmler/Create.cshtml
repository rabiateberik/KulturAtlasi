@model KulturAtlasi.Models.Film

@{
    ViewData["Title"] = "Yeni Film Ekle";
}

<div class="container py-4">
    <div class="row">
        <div class="col-md-5">
            <div class="card shadow-sm border-0 mb-3 bg-light">
                <div class="card-body">
                    <h5 class="card-title fw-bold mb-3"><i class="bi bi-search"></i> Film Ara (TMDb)</h5>
                    <div class="input-group">
                        <input type="text" id="txtFilmAra" class="form-control" placeholder="Film adı (Örn: Inception)...">
                        <button class="btn btn-danger" type="button" onclick="filmAra()">Bul</button>
                    </div>
                </div>
            </div>

            <div id="sonucListesi" class="list-group mb-4 shadow-sm" style="display:none; max-height: 400px; overflow-y: auto;">
            </div>

            <div class="card shadow border-0 text-center p-3" id="onizlemeKarti" style="display:none;">
                <span class="badge bg-success position-absolute top-0 end-0 m-2">Seçildi <i class="bi bi-check"></i></span>
                <img id="imgOnizleme" src="" class="img-fluid rounded mx-auto d-block shadow-sm" style="max-height: 400px;" alt="Afiş">

                <div class="mt-3">
                    <label class="small text-muted">Afiş görünmüyor mu?</label>
                    <div class="input-group input-group-sm">
                        <input type="text" id="txtManuelPoster" class="form-control" placeholder="Resim linki yapıştır..." onchange="manuelPosterGuncelle()">
                        <button class="btn btn-outline-secondary" type="button" onclick="manuelPosterGuncelle()">Güncelle</button>
                    </div>
                </div>

                <h5 id="lblBaslik" class="fw-bold mt-3 text-dark"></h5>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card shadow border-0">
                <div class="card-header bg-danger text-white py-3">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-camera-reels"></i> Film Bilgileri</h5>
                </div>
                <div class="card-body">
                    <form asp-action="Create">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        <input type="hidden" asp-for="PosterYolu" id="inputPoster" />

                        <div class="mb-3">
                            <label asp-for="Baslik" class="form-label fw-bold">Film Adı</label>
                            <input asp-for="Baslik" class="form-control" id="inputBaslik" />
                            <span asp-validation-for="Baslik" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Tur" class="form-label fw-bold text-primary">Türü (Otomatik)</label>
                            <input asp-for="Tur" class="form-control bg-light" id="inputTur" readonly />
                            <span asp-validation-for="Tur" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Yonetmen" class="form-label fw-bold">Yönetmen</label>
                                <input asp-for="Yonetmen" class="form-control" id="inputYonetmen" />
                                <span asp-validation-for="Yonetmen" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Yil" class="form-label">Çıkış Yılı</label>
                                <input asp-for="Yil" class="form-control" id="inputYil" />
                                <span asp-validation-for="Yil" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold bg-warning bg-opacity-10 px-2 rounded">Durumu</label>
                                <select asp-for="DurumID" class="form-select" asp-items="ViewBag.DurumID"></select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="KullaniciPuani" class="form-label">Puanım (1-5)</label>
                                <input asp-for="KullaniciPuani" type="number" min="1" max="5" class="form-control" value="0" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Aciklama" class="form-label">Konusu / Özet</label>
                            <textarea asp-for="Aciklama" class="form-control" id="inputAciklama" rows="4"></textarea>
                            <span asp-validation-for="Aciklama" class="text-danger"></span>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check-lg"></i> Arşive Ekle
                            </button>
                            <a asp-action="Index" class="btn btn-outline-secondary">İptal</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>

        // Razor koduyla C# tarafındaki anahtarı JS değişkenine aktarıyoruz
        const API_KEY = '@ViewBag.TmdbApiKey';

        const BASE_URL = 'https://api.themoviedb.org/3';
        const IMAGE_URL = 'https://image.tmdb.org/t/p/w500';
        async function filmAra() {
            var sorgu = document.getElementById("txtFilmAra").value;
            if (!sorgu) { alert("Film adı yazın!"); return; }

            var btn = event.target;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Aranıyor...';
            btn.disabled = true;

            try {
                const res = await fetch(`${BASE_URL}/search/movie?api_key=${API_KEY}&query=${sorgu}&language=tr-TR`);
                const data = await res.json();

                if (data.results && data.results.length > 0) {
                    listeyiDoldur(data.results);
                } else {
                    alert("Film bulunamadı!");
                    document.getElementById("sonucListesi").style.display = "none";
                }
            } catch (err) {
                console.error(err);
                alert("API Hatası!");
            } finally {
                btn.innerHTML = "Bul";
                btn.disabled = false;
            }
        }

        function listeyiDoldur(filmler) {
            var liste = document.getElementById("sonucListesi");
            liste.innerHTML = "";
            liste.style.display = "block";

            filmler.slice(0, 5).forEach(film => {
                var poster = film.poster_path ? IMAGE_URL + film.poster_path : "https://via.placeholder.com/50x75?text=Yok";
                var yil = film.release_date ? film.release_date.split('-')[0] : "Tarih Yok";

                var html = `
                    <button type="button" class="list-group-item list-group-item-action d-flex gap-3 py-2" onclick="filmDetayGetir(${film.id})">
                        <img src="${poster}" width="40" height="60" class="flex-shrink-0 rounded border" style="object-fit:cover;">
                        <div class="d-flex gap-2 w-100 justify-content-between">
                            <div>
                                <h6 class="mb-0 fw-bold">${film.title}</h6>
                                <p class="mb-0 opacity-75 small text-truncate" style="max-width: 200px;">${film.original_title}</p>
                            </div>
                            <small class="opacity-50 text-nowrap fw-bold">${yil}</small>
                        </div>
                    </button>
                `;
                liste.innerHTML += html;
            });
        }

        async function filmDetayGetir(filmId) {
            try {
                const res = await fetch(`${BASE_URL}/movie/${filmId}?api_key=${API_KEY}&language=tr-TR&append_to_response=credits`);
                const film = await res.json();

                // 1. Temel Bilgiler
                document.getElementById("inputBaslik").value = film.title;
                document.getElementById("inputYil").value = film.release_date ? film.release_date.split('-')[0] : "";
                document.getElementById("inputAciklama").value = film.overview;

                // 2. Yönetmeni Bul
                var yonetmen = "Bilinmiyor";
                if (film.credits && film.credits.crew) {
                    var director = film.credits.crew.find(x => x.job === "Director");
                    if (director) yonetmen = director.name;
                }
                document.getElementById("inputYonetmen").value = yonetmen;

                // ✨ 3. TURLERİ BUL VE YAZDIR (YENİ EKLENEN KISIM) ✨
                // API bize genres dizisi verir: [{name:"Dram"}, {name:"Suç"}]
                // Biz bunu "Dram, Suç" stringine çeviriyoruz.
                var turler = "";
                if (film.genres && film.genres.length > 0) {
                    turler = film.genres.map(g => g.name).join(", ");
                }
                document.getElementById("inputTur").value = turler;


                // 4. Poster
                var posterUrl = "";
                if (film.poster_path) {
                    posterUrl = IMAGE_URL + film.poster_path;
                }

                posterGuncelle(posterUrl);
                document.getElementById("lblBaslik").innerText = film.title;
                document.getElementById("sonucListesi").style.display = "none";

            } catch (err) {
                console.error(err);
                alert("Detaylar alınamadı.");
            }
        }

        function manuelPosterGuncelle() {
            var url = document.getElementById("txtManuelPoster").value;
            if(url) posterGuncelle(url);
        }

        function posterGuncelle(url) {
            var img = document.getElementById("imgOnizleme");
            var hiddenInput = document.getElementById("inputPoster");
            var placeholder = "https://via.placeholder.com/300x450?text=Afiş+Yok";
            var finalUrl = url ? url : placeholder;

            document.getElementById("onizlemeKarti").style.display = "block";
            img.src = finalUrl;
            hiddenInput.value = finalUrl;
            document.getElementById("txtManuelPoster").value = url;
            img.onerror = function() { this.src = placeholder; }
        }
    </script>
}